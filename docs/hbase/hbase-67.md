## 使用 Shell 管理 HBase

我们在第 4 章，第 5 章和第 6 章中看到的所有客户端 API 都具有 DDL 功能，但我更喜欢保持客户端代码免于管理工作，并使用 HBase Shell 脚本进行 DDL 和管理。还有一些只能从 Shell 获得的管理功能。

通常，您需要在 HBase 上执行的管理功能适用于未按预期方式使用表的情况，并且性能正在下降。表格在一个区域中具有比其他区域更多活动数据的热点可以通过手动拆分表来纠正。

split 命令可以在不同级别使用，可以分割命名区域或命名表。拆分现有表时，通常是因为您更了解数据的分布方式，HBase 允许您为新区域提供拆分键，如代码清单 63 所示：

代码清单 63：拆分现有表

```
hbase(main):006:0> split 'access-logs', 'ej'
0 row(s) in 0.4650 seconds

```

图 25 显示了主 UI 中的表格详细信息，在分割之后，原始 e 区域现在是两个独立的区域：

![](img/00036.jpeg)

图 25：主 UI 中的区域分割

手动拆分区域时，新区域将与原始区域位于同一服务器上。这保留了数据位置，因为原始数据全部在一台服务器上，但如果您想要删除热点并在更多服务器之间共享数据，则无效。

任何时候您的区域不平衡（例如，如果您手动拆分它们或添加新表），您可以使用平衡器命令强制重新平衡，该命令在没有参数的情况下运行，如图所示代码 64：

代码清单 64：启动负载均衡器

```
hbase(main):007:0> balancer
true                                                                                                                                       
0 row(s) in 0.0680 seconds

```

如果平衡器命令能够启动重新平衡过程，则返回 true 。平衡器实际上是异步运行的，并将在命令返回后继续。如果 Master 已经从另一个进程移动了区域，则无法启动重新平衡，命令将返回 false 。

可能损害性能的最终情况是，由于区域被移动或服务器被添加到群集，您的区域被拆分为多个商店文件，和/或您的数据位置较差。要解决这个问题，您需要一个主要的压缩，它将两个或多个存储文件组合成一个区域和列系列的 HFile，并确保每个 HFile 都是托管它的 Region Server 的本地。

HBase 将按计划大约每 24 小时运行一次主要压缩，如果在高峰访问时间内发生，将影响性能。如果您知道数据是碎片化的，那么最好在服务器负载较低时运行手动压缩。

使用 major_compact 命令启动压缩，您可以压缩整个表，列族，区域或区域内的一个列族。代码清单 65 显示了 access-logs 表的压缩开始：

代码清单 65：开始表的主要压缩

```
hbase(main):002:0> major_compact 'access-logs'
0 row(s) in 0.2990 seconds

```

压缩可能需要很长时间，尤其是对于具有许多区域的大型表。 Region Server UI 中的 Region 视图显示了压缩进度，但这一切都发生在后台，压缩区域在压缩运行时仍然可以读写。